{% extends "base.html" %}
{% load static %}

{% block scripts %}
<script>
    async function consultarTodasLasTasas() {
        try {
            const response = await fetch("/analisis_datos/todas_tasas/");
            const data = await response.json();
            document.getElementById("output-todas-las-tasas").value = JSON.stringify(data, null, 2);
        } catch (error) {
            console.error("Error al consultar todas las tasas:", error);
        }
    }

    async function consultarTasaPorFecha() {
        const fecha = document.getElementById("fecha-solicitud").value;
        if (!fecha) {
            alert("Por favor, selecciona una fecha.");
            return;
        }
        try {
            const response = await fetch(`/analisis_datos/tasa_por_fecha/?fecha=${fecha}`);
            const data = await response.json();
            document.getElementById("output-tasa-por-fecha").value = data.tasa || "No encontrada";
        } catch (error) {
            console.error("Error al consultar la tasa por fecha:", error);
        }
    }

    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length);
            }
        }
        return null;
    }

    async function subirNuevaTasa() {
        const fecha = document.getElementById("fecha-nueva-tasa").value;
        const tasa = document.getElementById("nueva-tasa").value;
        const csrfToken = getCSRFToken(); // Obtener el token CSRF

        if (!fecha || !tasa) {
            alert("Por favor, completa ambos campos.");
            return;
        }

        try {
            const response = await fetch("/analisis_datos/subir_tasa/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken, // Agregar el token CSRF en el encabezado
                },
                body: new URLSearchParams({ fecha, tasa }),
            });

            if (!response.ok) {
                throw new Error("Error en la solicitud al servidor.");
            }

            const data = await response.json();
            alert(data.mensaje);
        } catch (error) {
            console.error("Error al subir la nueva tasa:", error);
        }
    }

    async function obtenerUltimaTasa() {
        try {
            const response = await fetch("/analisis_datos/ultima_tasa/");
            const data = await response.json();
            document.getElementById("output-ultima-tasa").value = data.tasa;
        } catch (error) {
            console.error("Error al obtener la última tasa:", error);
        }
    }

    async function consultarRangoTasas() {
        const fechaInicio = document.getElementById("fecha-inicio-rango").value;
        const fechaFin = document.getElementById("fecha-fin-rango").value;
        if (!fechaInicio || !fechaFin) {
            alert("Por favor, selecciona ambas fechas.");
            return;
        }
        try {
            const response = await fetch(`/analisis_datos/rango_tasas/?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`);
            const data = await response.json();
            document.getElementById("output-rango-tasas").value = JSON.stringify(data, null, 2);
        } catch (error) {
            console.error("Error al consultar el rango de tasas:", error);
        }
    }
</script>
{% endblock %}

{% block content %}
<section class="propietario p-6 rounded-lg relative flex justify-center">
    <div class="flex w-full justify-center space-x-8">

        <!-- Cuadro del Formulario -->
        <div class="bg-white rounded-lg shadow-md p-10 flex flex-col justify-between" style="width: 800px;">
            <h1 class="text-2xl font-bold mb-5 text-center">Análisis de Datos</h1>

            <!-- Consultar Todas las Tasas -->
            <div class="w-full px-4 mb-12">
                <textarea id="output-todas-las-tasas" rows="10" readonly class="w-full rounded-lg border border-gray-300 resize-none overflow-auto p-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4"></textarea>
                <button onclick="consultarTodasLasTasas()" class="w-full bg-indigo-900 text-white py-2 px-4 my-2 rounded-lg hover:bg-blue-900 hover:font-semibold hover:text-white transition-all duration-900 ease-in-out scale-100 active:bg-blue-900 active:text-white active:scale-95 max-[900px]:ml-auto max-[900px]:mr-4">
                    Consultar Todas las Tasas
                </button>
            </div>

            <!-- Consultar Tasa por Fecha -->
            <div class="w-full px-4 mb-12">
                <input type="date" id="fecha-solicitud" class="w-full rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <button onclick="consultarTasaPorFecha()" class="w-full bg-indigo-900 text-white py-2 px-4 my-2 rounded-lg hover:bg-blue-900 hover:font-semibold hover:text-white transition-all duration-900 ease-in-out scale-100 active:bg-blue-900 active:text-white active:scale-95 max-[900px]:ml-auto max-[900px]:mr-4">
                    Consultar Por Fecha
                </button>
                <input id="output-tasa-por-fecha" readonly class="w-full mt-4 rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Subir Nueva Tasa -->
            <div class="w-full px-4 mb-12">
                <input type="date" id="fecha-nueva-tasa" class="w-full rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <input type="text" id="nueva-tasa" placeholder="Ej: 66.2707" class="w-full rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <button onclick="subirNuevaTasa()" class="w-full bg-indigo-900 text-white py-2 px-4 my-2 rounded-lg hover:bg-blue-900 hover:font-semibold hover:text-white transition-all duration-900 ease-in-out scale-100 active:bg-blue-900 active:text-white active:scale-95 max-[900px]:ml-auto max-[900px]:mr-4">
                    Subir Tasa
                </button>
            </div>

            <!-- Obtener Última Tasa -->
            <div class="w-full px-4 mb-12">
                <input id="output-ultima-tasa" readonly class="w-full mb-4 rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button onclick="obtenerUltimaTasa()" class="w-full bg-indigo-900 text-white py-2 px-4 my-2 rounded-lg hover:bg-blue-900 hover:font-semibold hover:text-white transition-all duration-900 ease-in-out scale-100 active:bg-blue-900 active:text-white active:scale-95 max-[900px]:ml-auto max-[900px]:mr-4">
                    Obtener Última Tasa
                </button>
            </div>

            <!-- Consultar Rango de Tasas -->
            <div class="w-full px-4 mb-12">
                <input type="date" id="fecha-inicio-rango" class="w-full rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <input type="date" id="fecha-fin-rango" class="w-full rounded-lg border border-gray-300 py-2 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent mb-4">
                <button onclick="consultarRangoTasas()" class="w-full bg-indigo-900 text-white py-2 px-4 my-2 rounded-lg hover:bg-blue-900 hover:font-semibold hover:text-white transition-all duration-900 ease-in-out scale-100 active:bg-blue-900 active:text-white active:scale-95 max-[900px]:ml-auto max-[900px]:mr-4">
                    Consultar Rango de Tasas
                </button>
                <textarea id="output-rango-tasas" rows="10" readonly class="w-full mt-4 rounded-lg border border-gray-300 resize-none overflow-auto p-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
            </div>
        </div>
    </div>
</section>
{% endblock %}